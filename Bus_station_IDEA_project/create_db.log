
-------
05/16/2017 18:16:37
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

-------
05/17/2017 18:17:54
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

-------
05/26/2017 18:26:11
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

-------
05/26/2017 18:26:57
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 


-------
05/28/2017 18:28:06
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  -- 1
                                         ('Мосгортранс'),   -- 2
                                         ('АвтоТрансЮг');   -- 3
INSERT INTO Stations(StationName) VALUES('Москва'),            -- 1
                                        ('Тверь'),             -- 2
                                        ('Великий Новгород'),  -- 3
                                        ('Санкт-Петербург'),   -- 4
                                        ('Ярославль'),         -- 5
                                        ('Вологда'),           -- 6
                                        ('Череповец'),         -- 7
                                        ('Владимир'),          -- 8
                                        ('Нижний Новгород'),   -- 9
                                        ('Казань'),            -- 10
                                        ('Липецк'),            -- 11
                                        ('Воронеж'),           -- 12
                                        ('Ростов-на-Дону'),    -- 13
                                        ('Краснодар'),         -- 14
                                        ('Сочи'),              -- 15
                                        ('Рязань'),            -- 16
                                        ('Пенза'),             -- 17
                                        ('Ульяновск'),         -- 18
                                        ('Тольятти'),          -- 19
                                        ('Самара');            -- 20
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  -- 1
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  -- 2
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  -- 3
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  -- 4
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com');  -- 5
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  -- 1
                ('ЭК-946',  2,       56         ),  -- 2
                ('479МА',   3,       60         ),  -- 3
                ('ЮА79К',   3,       56         ),  -- 4
                ('9368',    2,       48         ),  -- 5
                ('ST36',    1,       56         ),  -- 6
                ('MA-397',  2,       52         ),  -- 7
                ('EW-98',   3,       58         ),  -- 8
                ('В-269',   2,       60         ),  -- 9
                ('СП-248',  1,       52         );  -- 10
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  -- 1
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  -- 2
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  -- 3
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  -- 4
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  -- 5
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 6
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 7
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  -- 8
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  -- 9
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 10
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  -- 11
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  -- 12
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  -- 13
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 14
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  -- 15
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  -- 16
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  -- 17
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  -- 18
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  -- 19
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  -- 20
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  -- 21
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  -- 22
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  -- 23
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  -- 24
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  -- 25
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  -- 26
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  -- 27
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  -- 28
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  -- 29
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  -- 30
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  -- 31
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  -- 32
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  -- 33
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  -- 34
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  -- 35
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  -- 36
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  -- 37
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  -- 38
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  -- 39
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  -- 40
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  -- 41
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  -- 42
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  -- 43
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  -- 44
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  -- 45
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  -- 46
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  -- 47
                    (10,  1,       '2017-03-08 01:00:00', NULL                 );  -- 48
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  -- 1
                 (1,      3,    800  ),  -- 2
                 (1,      4,    1000 ),  -- 3
                 (2,      3,    600  ),  -- 4
                 (2,      4,    800  ),  -- 5
                 (3,      4,    600  ),  -- 6
                 (5,      6,    600  ),  -- 7
                 (5,      7,    800  ),  -- 8
                 (5,      8,    1000 ),  -- 9
                 (6,      7,    600  ),  -- 10
                 (6,      8,    800  ),  -- 11
                 (7,      8,    600  ),  -- 12
                 (9,      10,   600  ),  -- 13
                 (9,      11,   800  ),  -- 14
                 (9,      12,   1000 ),  -- 15
                 (10,     11,   600  ),  -- 16
                 (10,     12,   800  ),  -- 17
                 (11,     12,   600  ),  -- 18
                 (13,     14,   600  ),  -- 19
                 (13,     15,   800  ),  -- 20
                 (13,     16,   1000 ),  -- 21
                 (14,     15,   600  ),  -- 22
                 (14,     16,   800  ),  -- 23
                 (15,     16,   600  ),  -- 24
                 (17,     18,   600  ),  -- 25
                 (17,     19,   800  ),  -- 26
                 (17,     20,   1000 ),  -- 27
                 (18,     19,   600  ),  -- 28
                 (18,     20,   800  ),  -- 29
                 (19,     20,   600  ),  -- 30
                 (21,     22,   600  ),  -- 31
                 (21,     23,   800  ),  -- 32
                 (21,     24,   1000 ),  -- 33
                 (22,     23,   600  ),  -- 34
                 (22,     24,   800  ),  -- 35
                 (23,     24,   600  ),  -- 36
                 (25,     26,   600  ),  -- 37
                 (25,     27,   800  ),  -- 38
                 (25,     28,   1000 ),  -- 39
                 (25,     29,   1200 ),  -- 40
                 (25,     30,   1400 ),  -- 41
                 (26,     27,   600  ),  -- 42
                 (26,     28,   800  ),  -- 43
                 (26,     29,   1000 ),  -- 44
                 (26,     30,   1200 ),  -- 45
                 (27,     28,   600  ),  -- 46
                 (27,     29,   800  ),  -- 47
                 (27,     30,   1000 ),  -- 48
                 (28,     29,   600  ),  -- 49
                 (28,     30,   800  ),  -- 50
                 (29,     30,   600  ),  -- 51
                 (31,     32,   600  ),  -- 52
                 (31,     33,   800  ),  -- 53
                 (31,     34,   1000 ),  -- 54
                 (31,     35,   1200 ),  -- 55
                 (31,     36,   1400 ),  -- 56
                 (32,     33,   600  ),  -- 57
                 (32,     34,   800  ),  -- 58
                 (32,     35,   1000 ),  -- 59
                 (32,     36,   1200 ),  -- 60
                 (33,     34,   600  ),  -- 61
                 (33,     35,   800  ),  -- 62
                 (33,     36,   1000 ),  -- 63
                 (34,     35,   600  ),  -- 64
                 (34,     36,   800  ),  -- 65
                 (35,     36,   600  ),  -- 66
                 (37,     38,   600  ),  -- 67
                 (37,     39,   800  ),  -- 68
                 (37,     40,   1000 ),  -- 69
                 (37,     41,   1200 ),  -- 70
                 (37,     42,   1400 ),  -- 71
                 (38,     39,   600  ),  -- 72
                 (38,     40,   800  ),  -- 73
                 (38,     41,   1000 ),  -- 74
                 (38,     42,   1200 ),  -- 75
                 (39,     40,   600  ),  -- 76
                 (39,     41,   800  ),  -- 77
                 (39,     42,   1000 ),  -- 78
                 (40,     41,   600  ),  -- 79
                 (40,     42,   800  ),  -- 80
                 (41,     42,   600  ),  -- 81
                 (43,     44,   600  ),  -- 82
                 (43,     45,   800  ),  -- 83
                 (43,     46,   1000 ),  -- 84
                 (43,     47,   1200 ),  -- 85
                 (43,     48,   1400 ),  -- 86
                 (44,     45,   600  ),  -- 87
                 (44,     46,   800  ),  -- 88
                 (44,     47,   1000 ),  -- 89
                 (44,     48,   1200 ),  -- 90
                 (45,     46,   600  ),  -- 91
                 (45,     47,   800  ),  -- 92
                 (45,     48,   1000 ),  -- 93
                 (46,     47,   600  ),  -- 94
                 (46,     48,   800  ),  -- 95
                 (47,     48,   600  );  -- 96
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  -- 1
                  (1,        9,    25   ),  -- 2
                  (1,        14,   22   ),  -- 3
                  (1,        23,   22   ),  -- 4
                  (2,        14,   25   ),  -- 5
                  (2,        23,   25   ),  -- 6
                  (2,        27,   20   ),  -- 7
                  (2,        33,   20   ),  -- 8
                  (3,        27,   25   ),  -- 9
                  (3,        33,   25   ),  -- 10
                  (3,        41,   25   ),  -- 11
                  (3,        56,   25   ),  -- 12
                  (4,        41,   17   ),  -- 13
                  (4,        56,   17   ),  -- 14
                  (4,        69,   23   ),  -- 15
                  (4,        93,   23   ),  -- 16
                  (5,        69,   25   ),  -- 17
                  (5,        93,   25   ),  -- 18
                  (5,        3,    21   ),  -- 19
                  (5,        9,    21   );  -- 20


-------
05/29/2017 18:29:58
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END

USE Bus_station;
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  -- 1
                                         ('Мосгортранс'),   -- 2
                                         ('АвтоТрансЮг');   -- 3
INSERT INTO Stations(StationName) VALUES('Москва'),            -- 1
                                        ('Тверь'),             -- 2
                                        ('Великий Новгород'),  -- 3
                                        ('Санкт-Петербург'),   -- 4
                                        ('Ярославль'),         -- 5
                                        ('Вологда'),           -- 6
                                        ('Череповец'),         -- 7
                                        ('Владимир'),          -- 8
                                        ('Нижний Новгород'),   -- 9
                                        ('Казань'),            -- 10
                                        ('Липецк'),            -- 11
                                        ('Воронеж'),           -- 12
                                        ('Ростов-на-Дону'),    -- 13
                                        ('Краснодар'),         -- 14
                                        ('Сочи'),              -- 15
                                        ('Рязань'),            -- 16
                                        ('Пенза'),             -- 17
                                        ('Ульяновск'),         -- 18
                                        ('Тольятти'),          -- 19
                                        ('Самара');            -- 20
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  -- 1
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  -- 2
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  -- 3
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  -- 4
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com');  -- 5
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  -- 1
                ('ЭК-946',  2,       56         ),  -- 2
                ('479МА',   3,       60         ),  -- 3
                ('ЮА79К',   3,       56         ),  -- 4
                ('9368',    2,       48         ),  -- 5
                ('ST36',    1,       56         ),  -- 6
                ('MA-397',  2,       52         ),  -- 7
                ('EW-98',   3,       58         ),  -- 8
                ('В-269',   2,       60         ),  -- 9
                ('СП-248',  1,       52         );  -- 10
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  -- 1
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  -- 2
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  -- 3
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  -- 4
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  -- 5
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 6
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 7
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  -- 8
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  -- 9
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 10
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  -- 11
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  -- 12
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  -- 13
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 14
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  -- 15
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  -- 16
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  -- 17
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  -- 18
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  -- 19
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  -- 20
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  -- 21
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  -- 22
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  -- 23
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  -- 24
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  -- 25
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  -- 26
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  -- 27
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  -- 28
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  -- 29
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  -- 30
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  -- 31
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  -- 32
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  -- 33
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  -- 34
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  -- 35
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  -- 36
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  -- 37
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  -- 38
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  -- 39
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  -- 40
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  -- 41
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  -- 42
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  -- 43
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  -- 44
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  -- 45
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  -- 46
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  -- 47
                    (10,  1,       '2017-03-08 01:00:00', NULL                 );  -- 48
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  -- 1
                 (1,      3,    800  ),  -- 2
                 (1,      4,    1000 ),  -- 3
                 (2,      3,    600  ),  -- 4
                 (2,      4,    800  ),  -- 5
                 (3,      4,    600  ),  -- 6
                 (5,      6,    600  ),  -- 7
                 (5,      7,    800  ),  -- 8
                 (5,      8,    1000 ),  -- 9
                 (6,      7,    600  ),  -- 10
                 (6,      8,    800  ),  -- 11
                 (7,      8,    600  ),  -- 12
                 (9,      10,   600  ),  -- 13
                 (9,      11,   800  ),  -- 14
                 (9,      12,   1000 ),  -- 15
                 (10,     11,   600  ),  -- 16
                 (10,     12,   800  ),  -- 17
                 (11,     12,   600  ),  -- 18
                 (13,     14,   600  ),  -- 19
                 (13,     15,   800  ),  -- 20
                 (13,     16,   1000 ),  -- 21
                 (14,     15,   600  ),  -- 22
                 (14,     16,   800  ),  -- 23
                 (15,     16,   600  ),  -- 24
                 (17,     18,   600  ),  -- 25
                 (17,     19,   800  ),  -- 26
                 (17,     20,   1000 ),  -- 27
                 (18,     19,   600  ),  -- 28
                 (18,     20,   800  ),  -- 29
                 (19,     20,   600  ),  -- 30
                 (21,     22,   600  ),  -- 31
                 (21,     23,   800  ),  -- 32
                 (21,     24,   1000 ),  -- 33
                 (22,     23,   600  ),  -- 34
                 (22,     24,   800  ),  -- 35
                 (23,     24,   600  ),  -- 36
                 (25,     26,   600  ),  -- 37
                 (25,     27,   800  ),  -- 38
                 (25,     28,   1000 ),  -- 39
                 (25,     29,   1200 ),  -- 40
                 (25,     30,   1400 ),  -- 41
                 (26,     27,   600  ),  -- 42
                 (26,     28,   800  ),  -- 43
                 (26,     29,   1000 ),  -- 44
                 (26,     30,   1200 ),  -- 45
                 (27,     28,   600  ),  -- 46
                 (27,     29,   800  ),  -- 47
                 (27,     30,   1000 ),  -- 48
                 (28,     29,   600  ),  -- 49
                 (28,     30,   800  ),  -- 50
                 (29,     30,   600  ),  -- 51
                 (31,     32,   600  ),  -- 52
                 (31,     33,   800  ),  -- 53
                 (31,     34,   1000 ),  -- 54
                 (31,     35,   1200 ),  -- 55
                 (31,     36,   1400 ),  -- 56
                 (32,     33,   600  ),  -- 57
                 (32,     34,   800  ),  -- 58
                 (32,     35,   1000 ),  -- 59
                 (32,     36,   1200 ),  -- 60
                 (33,     34,   600  ),  -- 61
                 (33,     35,   800  ),  -- 62
                 (33,     36,   1000 ),  -- 63
                 (34,     35,   600  ),  -- 64
                 (34,     36,   800  ),  -- 65
                 (35,     36,   600  ),  -- 66
                 (37,     38,   600  ),  -- 67
                 (37,     39,   800  ),  -- 68
                 (37,     40,   1000 ),  -- 69
                 (37,     41,   1200 ),  -- 70
                 (37,     42,   1400 ),  -- 71
                 (38,     39,   600  ),  -- 72
                 (38,     40,   800  ),  -- 73
                 (38,     41,   1000 ),  -- 74
                 (38,     42,   1200 ),  -- 75
                 (39,     40,   600  ),  -- 76
                 (39,     41,   800  ),  -- 77
                 (39,     42,   1000 ),  -- 78
                 (40,     41,   600  ),  -- 79
                 (40,     42,   800  ),  -- 80
                 (41,     42,   600  ),  -- 81
                 (43,     44,   600  ),  -- 82
                 (43,     45,   800  ),  -- 83
                 (43,     46,   1000 ),  -- 84
                 (43,     47,   1200 ),  -- 85
                 (43,     48,   1400 ),  -- 86
                 (44,     45,   600  ),  -- 87
                 (44,     46,   800  ),  -- 88
                 (44,     47,   1000 ),  -- 89
                 (44,     48,   1200 ),  -- 90
                 (45,     46,   600  ),  -- 91
                 (45,     47,   800  ),  -- 92
                 (45,     48,   1000 ),  -- 93
                 (46,     47,   600  ),  -- 94
                 (46,     48,   800  ),  -- 95
                 (47,     48,   600  );  -- 96
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  -- 1
                  (1,        9,    25   ),  -- 2
                  (1,        14,   22   ),  -- 3
                  (1,        23,   22   ),  -- 4
                  (2,        14,   25   ),  -- 5
                  (2,        23,   25   ),  -- 6
                  (2,        27,   20   ),  -- 7
                  (2,        33,   20   ),  -- 8
                  (3,        27,   25   ),  -- 9
                  (3,        33,   25   ),  -- 10
                  (3,        41,   25   ),  -- 11
                  (3,        56,   25   ),  -- 12
                  (4,        41,   17   ),  -- 13
                  (4,        56,   17   ),  -- 14
                  (4,        69,   23   ),  -- 15
                  (4,        93,   23   ),  -- 16
                  (5,        69,   25   ),  -- 17
                  (5,        93,   25   ),  -- 18
                  (5,        3,    21   ),  -- 19
                  (5,        9,    21   )   -- 20


-------
05/30/2017 18:30:35
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END

USE Bus_station;
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  -- 1
                                         ('Мосгортранс'),   -- 2
                                         ('АвтоТрансЮг');   -- 3
INSERT INTO Stations(StationName) VALUES('Москва'),            -- 1
                                        ('Тверь'),             -- 2
                                        ('Великий Новгород'),  -- 3
                                        ('Санкт-Петербург'),   -- 4
                                        ('Ярославль'),         -- 5
                                        ('Вологда'),           -- 6
                                        ('Череповец'),         -- 7
                                        ('Владимир'),          -- 8
                                        ('Нижний Новгород'),   -- 9
                                        ('Казань'),            -- 10
                                        ('Липецк'),            -- 11
                                        ('Воронеж'),           -- 12
                                        ('Ростов-на-Дону'),    -- 13
                                        ('Краснодар'),         -- 14
                                        ('Сочи'),              -- 15
                                        ('Рязань'),            -- 16
                                        ('Пенза'),             -- 17
                                        ('Ульяновск'),         -- 18
                                        ('Тольятти'),          -- 19
                                        ('Самара');            -- 20
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  -- 1
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  -- 2
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  -- 3
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  -- 4
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com');  -- 5
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  -- 1
                ('ЭК-946',  2,       56         ),  -- 2
                ('479МА',   3,       60         ),  -- 3
                ('ЮА79К',   3,       56         ),  -- 4
                ('9368',    2,       48         ),  -- 5
                ('ST36',    1,       56         ),  -- 6
                ('MA-397',  2,       52         ),  -- 7
                ('EW-98',   3,       58         ),  -- 8
                ('В-269',   2,       60         ),  -- 9
                ('СП-248',  1,       52         );  -- 10
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  -- 1
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  -- 2
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  -- 3
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  -- 4
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  -- 5
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 6
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 7
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  -- 8
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  -- 9
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 10
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  -- 11
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  -- 12
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  -- 13
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 14
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  -- 15
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  -- 16
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  -- 17
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  -- 18
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  -- 19
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  -- 20
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  -- 21
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  -- 22
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  -- 23
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  -- 24
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  -- 25
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  -- 26
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  -- 27
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  -- 28
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  -- 29
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  -- 30
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  -- 31
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  -- 32
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  -- 33
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  -- 34
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  -- 35
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  -- 36
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  -- 37
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  -- 38
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  -- 39
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  -- 40
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  -- 41
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  -- 42
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  -- 43
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  -- 44
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  -- 45
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  -- 46
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  -- 47
                    (10,  1,       '2017-03-08 01:00:00', NULL                 );  -- 48
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  -- 1
                 (1,      3,    800  ),  -- 2
                 (1,      4,    1000 ),  -- 3
                 (2,      3,    600  ),  -- 4
                 (2,      4,    800  ),  -- 5
                 (3,      4,    600  ),  -- 6
                 (5,      6,    600  ),  -- 7
                 (5,      7,    800  ),  -- 8
                 (5,      8,    1000 ),  -- 9
                 (6,      7,    600  ),  -- 10
                 (6,      8,    800  ),  -- 11
                 (7,      8,    600  ),  -- 12
                 (9,      10,   600  ),  -- 13
                 (9,      11,   800  ),  -- 14
                 (9,      12,   1000 ),  -- 15
                 (10,     11,   600  ),  -- 16
                 (10,     12,   800  ),  -- 17
                 (11,     12,   600  ),  -- 18
                 (13,     14,   600  ),  -- 19
                 (13,     15,   800  ),  -- 20
                 (13,     16,   1000 ),  -- 21
                 (14,     15,   600  ),  -- 22
                 (14,     16,   800  ),  -- 23
                 (15,     16,   600  ),  -- 24
                 (17,     18,   600  ),  -- 25
                 (17,     19,   800  ),  -- 26
                 (17,     20,   1000 ),  -- 27
                 (18,     19,   600  ),  -- 28
                 (18,     20,   800  ),  -- 29
                 (19,     20,   600  ),  -- 30
                 (21,     22,   600  ),  -- 31
                 (21,     23,   800  ),  -- 32
                 (21,     24,   1000 ),  -- 33
                 (22,     23,   600  ),  -- 34
                 (22,     24,   800  ),  -- 35
                 (23,     24,   600  ),  -- 36
                 (25,     26,   600  ),  -- 37
                 (25,     27,   800  ),  -- 38
                 (25,     28,   1000 ),  -- 39
                 (25,     29,   1200 ),  -- 40
                 (25,     30,   1400 ),  -- 41
                 (26,     27,   600  ),  -- 42
                 (26,     28,   800  ),  -- 43
                 (26,     29,   1000 ),  -- 44
                 (26,     30,   1200 ),  -- 45
                 (27,     28,   600  ),  -- 46
                 (27,     29,   800  ),  -- 47
                 (27,     30,   1000 ),  -- 48
                 (28,     29,   600  ),  -- 49
                 (28,     30,   800  ),  -- 50
                 (29,     30,   600  ),  -- 51
                 (31,     32,   600  ),  -- 52
                 (31,     33,   800  ),  -- 53
                 (31,     34,   1000 ),  -- 54
                 (31,     35,   1200 ),  -- 55
                 (31,     36,   1400 ),  -- 56
                 (32,     33,   600  ),  -- 57
                 (32,     34,   800  ),  -- 58
                 (32,     35,   1000 ),  -- 59
                 (32,     36,   1200 ),  -- 60
                 (33,     34,   600  ),  -- 61
                 (33,     35,   800  ),  -- 62
                 (33,     36,   1000 ),  -- 63
                 (34,     35,   600  ),  -- 64
                 (34,     36,   800  ),  -- 65
                 (35,     36,   600  ),  -- 66
                 (37,     38,   600  ),  -- 67
                 (37,     39,   800  ),  -- 68
                 (37,     40,   1000 ),  -- 69
                 (37,     41,   1200 ),  -- 70
                 (37,     42,   1400 ),  -- 71
                 (38,     39,   600  ),  -- 72
                 (38,     40,   800  ),  -- 73
                 (38,     41,   1000 ),  -- 74
                 (38,     42,   1200 ),  -- 75
                 (39,     40,   600  ),  -- 76
                 (39,     41,   800  ),  -- 77
                 (39,     42,   1000 ),  -- 78
                 (40,     41,   600  ),  -- 79
                 (40,     42,   800  ),  -- 80
                 (41,     42,   600  ),  -- 81
                 (43,     44,   600  ),  -- 82
                 (43,     45,   800  ),  -- 83
                 (43,     46,   1000 ),  -- 84
                 (43,     47,   1200 ),  -- 85
                 (43,     48,   1400 ),  -- 86
                 (44,     45,   600  ),  -- 87
                 (44,     46,   800  ),  -- 88
                 (44,     47,   1000 ),  -- 89
                 (44,     48,   1200 ),  -- 90
                 (45,     46,   600  ),  -- 91
                 (45,     47,   800  ),  -- 92
                 (45,     48,   1000 ),  -- 93
                 (46,     47,   600  ),  -- 94
                 (46,     48,   800  ),  -- 95
                 (47,     48,   600  );  -- 96
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  -- 1
                  (1,        9,    25   ),  -- 2
                  (1,        14,   22   ),  -- 3
                  (1,        23,   22   ),  -- 4
                  (2,        14,   25   ),  -- 5
                  (2,        23,   25   ),  -- 6
                  (2,        27,   20   ),  -- 7
                  (2,        33,   20   ),  -- 8
                  (3,        27,   25   ),  -- 9
                  (3,        33,   25   ),  -- 10
                  (3,        41,   25   ),  -- 11
                  (3,        56,   25   ),  -- 12
                  (4,        41,   17   ),  -- 13
                  (4,        56,   17   ),  -- 14
                  (4,        69,   23   ),  -- 15
                  (4,        93,   23   ),  -- 16
                  (5,        69,   25   ),  -- 17
                  (5,        93,   25   ),  -- 18
                  (5,        3,    21   ),  -- 19
                  (5,        9,    21   )   -- 20


-------
05/31/2017 18:31:07
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END

USE Bus_station;
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  -- 1
                                         ('Мосгортранс'),   -- 2
                                         ('АвтоТрансЮг');   -- 3
INSERT INTO Stations(StationName) VALUES('Москва'),            -- 1
                                        ('Тверь'),             -- 2
                                        ('Великий Новгород'),  -- 3
                                        ('Санкт-Петербург'),   -- 4
                                        ('Ярославль'),         -- 5
                                        ('Вологда'),           -- 6
                                        ('Череповец'),         -- 7
                                        ('Владимир'),          -- 8
                                        ('Нижний Новгород'),   -- 9
                                        ('Казань'),            -- 10
                                        ('Липецк'),            -- 11
                                        ('Воронеж'),           -- 12
                                        ('Ростов-на-Дону'),    -- 13
                                        ('Краснодар'),         -- 14
                                        ('Сочи'),              -- 15
                                        ('Рязань'),            -- 16
                                        ('Пенза'),             -- 17
                                        ('Ульяновск'),         -- 18
                                        ('Тольятти'),          -- 19
                                        ('Самара');            -- 20
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  -- 1
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  -- 2
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  -- 3
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  -- 4
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com');  -- 5
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  -- 1
                ('ЭК-946',  2,       56         ),  -- 2
                ('479МА',   3,       60         ),  -- 3
                ('ЮА79К',   3,       56         ),  -- 4
                ('9368',    2,       48         ),  -- 5
                ('ST36',    1,       56         ),  -- 6
                ('MA-397',  2,       52         ),  -- 7
                ('EW-98',   3,       58         ),  -- 8
                ('В-269',   2,       60         ),  -- 9
                ('СП-248',  1,       52         );  -- 10
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  -- 1
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  -- 2
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  -- 3
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  -- 4
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  -- 5
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 6
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 7
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  -- 8
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  -- 9
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 10
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  -- 11
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  -- 12
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  -- 13
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 14
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  -- 15
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  -- 16
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  -- 17
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  -- 18
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  -- 19
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  -- 20
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  -- 21
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  -- 22
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  -- 23
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  -- 24
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  -- 25
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  -- 26
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  -- 27
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  -- 28
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  -- 29
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  -- 30
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  -- 31
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  -- 32
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  -- 33
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  -- 34
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  -- 35
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  -- 36
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  -- 37
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  -- 38
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  -- 39
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  -- 40
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  -- 41
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  -- 42
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  -- 43
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  -- 44
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  -- 45
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  -- 46
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  -- 47
                    (10,  1,       '2017-03-08 01:00:00', NULL                 );  -- 48
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  -- 1
                 (1,      3,    800  ),  -- 2
                 (1,      4,    1000 ),  -- 3
                 (2,      3,    600  ),  -- 4
                 (2,      4,    800  ),  -- 5
                 (3,      4,    600  ),  -- 6
                 (5,      6,    600  ),  -- 7
                 (5,      7,    800  ),  -- 8
                 (5,      8,    1000 ),  -- 9
                 (6,      7,    600  ),  -- 10
                 (6,      8,    800  ),  -- 11
                 (7,      8,    600  ),  -- 12
                 (9,      10,   600  ),  -- 13
                 (9,      11,   800  ),  -- 14
                 (9,      12,   1000 ),  -- 15
                 (10,     11,   600  ),  -- 16
                 (10,     12,   800  ),  -- 17
                 (11,     12,   600  ),  -- 18
                 (13,     14,   600  ),  -- 19
                 (13,     15,   800  ),  -- 20
                 (13,     16,   1000 ),  -- 21
                 (14,     15,   600  ),  -- 22
                 (14,     16,   800  ),  -- 23
                 (15,     16,   600  ),  -- 24
                 (17,     18,   600  ),  -- 25
                 (17,     19,   800  ),  -- 26
                 (17,     20,   1000 ),  -- 27
                 (18,     19,   600  ),  -- 28
                 (18,     20,   800  ),  -- 29
                 (19,     20,   600  ),  -- 30
                 (21,     22,   600  ),  -- 31
                 (21,     23,   800  ),  -- 32
                 (21,     24,   1000 ),  -- 33
                 (22,     23,   600  ),  -- 34
                 (22,     24,   800  ),  -- 35
                 (23,     24,   600  ),  -- 36
                 (25,     26,   600  ),  -- 37
                 (25,     27,   800  ),  -- 38
                 (25,     28,   1000 ),  -- 39
                 (25,     29,   1200 ),  -- 40
                 (25,     30,   1400 ),  -- 41
                 (26,     27,   600  ),  -- 42
                 (26,     28,   800  ),  -- 43
                 (26,     29,   1000 ),  -- 44
                 (26,     30,   1200 ),  -- 45
                 (27,     28,   600  ),  -- 46
                 (27,     29,   800  ),  -- 47
                 (27,     30,   1000 ),  -- 48
                 (28,     29,   600  ),  -- 49
                 (28,     30,   800  ),  -- 50
                 (29,     30,   600  ),  -- 51
                 (31,     32,   600  ),  -- 52
                 (31,     33,   800  ),  -- 53
                 (31,     34,   1000 ),  -- 54
                 (31,     35,   1200 ),  -- 55
                 (31,     36,   1400 ),  -- 56
                 (32,     33,   600  ),  -- 57
                 (32,     34,   800  ),  -- 58
                 (32,     35,   1000 ),  -- 59
                 (32,     36,   1200 ),  -- 60
                 (33,     34,   600  ),  -- 61
                 (33,     35,   800  ),  -- 62
                 (33,     36,   1000 ),  -- 63
                 (34,     35,   600  ),  -- 64
                 (34,     36,   800  ),  -- 65
                 (35,     36,   600  ),  -- 66
                 (37,     38,   600  ),  -- 67
                 (37,     39,   800  ),  -- 68
                 (37,     40,   1000 ),  -- 69
                 (37,     41,   1200 ),  -- 70
                 (37,     42,   1400 ),  -- 71
                 (38,     39,   600  ),  -- 72
                 (38,     40,   800  ),  -- 73
                 (38,     41,   1000 ),  -- 74
                 (38,     42,   1200 ),  -- 75
                 (39,     40,   600  ),  -- 76
                 (39,     41,   800  ),  -- 77
                 (39,     42,   1000 ),  -- 78
                 (40,     41,   600  ),  -- 79
                 (40,     42,   800  ),  -- 80
                 (41,     42,   600  ),  -- 81
                 (43,     44,   600  ),  -- 82
                 (43,     45,   800  ),  -- 83
                 (43,     46,   1000 ),  -- 84
                 (43,     47,   1200 ),  -- 85
                 (43,     48,   1400 ),  -- 86
                 (44,     45,   600  ),  -- 87
                 (44,     46,   800  ),  -- 88
                 (44,     47,   1000 ),  -- 89
                 (44,     48,   1200 ),  -- 90
                 (45,     46,   600  ),  -- 91
                 (45,     47,   800  ),  -- 92
                 (45,     48,   1000 ),  -- 93
                 (46,     47,   600  ),  -- 94
                 (46,     48,   800  ),  -- 95
                 (47,     48,   600  );  -- 96
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  -- 1
                  (1,        9,    25   ),  -- 2
                  (1,        14,   22   ),  -- 3
                  (1,        23,   22   ),  -- 4
                  (2,        14,   25   ),  -- 5
                  (2,        23,   25   ),  -- 6
                  (2,        27,   20   ),  -- 7
                  (2,        33,   20   ),  -- 8
                  (3,        27,   25   ),  -- 9
                  (3,        33,   25   ),  -- 10
                  (3,        41,   25   ),  -- 11
                  (3,        56,   25   ),  -- 12
                  (4,        41,   17   ),  -- 13
                  (4,        56,   17   ),  -- 14
                  (4,        69,   23   ),  -- 15
                  (4,        93,   23   ),  -- 16
                  (5,        69,   25   ),  -- 17
                  (5,        93,   25   ),  -- 18
                  (5,        3,    21   ),  -- 19
                  (5,        9,    21   )   -- 20


-------
05/50/2017 18:50:01
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  -- 1
                                         ('Мосгортранс'),   -- 2
                                         ('АвтоТрансЮг');   -- 3
INSERT INTO Stations(StationName) VALUES('Москва'),            -- 1
                                        ('Тверь'),             -- 2
                                        ('Великий Новгород'),  -- 3
                                        ('Санкт-Петербург'),   -- 4
                                        ('Ярославль'),         -- 5
                                        ('Вологда'),           -- 6
                                        ('Череповец'),         -- 7
                                        ('Владимир'),          -- 8
                                        ('Нижний Новгород'),   -- 9
                                        ('Казань'),            -- 10
                                        ('Липецк'),            -- 11
                                        ('Воронеж'),           -- 12
                                        ('Ростов-на-Дону'),    -- 13
                                        ('Краснодар'),         -- 14
                                        ('Сочи'),              -- 15
                                        ('Рязань'),            -- 16
                                        ('Пенза'),             -- 17
                                        ('Ульяновск'),         -- 18
                                        ('Тольятти'),          -- 19
                                        ('Самара');            -- 20
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  -- 1
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  -- 2
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  -- 3
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  -- 4
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com');  -- 5
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  -- 1
                ('ЭК-946',  2,       56         ),  -- 2
                ('479МА',   3,       60         ),  -- 3
                ('ЮА79К',   3,       56         ),  -- 4
                ('9368',    2,       48         ),  -- 5
                ('ST36',    1,       56         ),  -- 6
                ('MA-397',  2,       52         ),  -- 7
                ('EW-98',   3,       58         ),  -- 8
                ('В-269',   2,       60         ),  -- 9
                ('СП-248',  1,       52         );  -- 10
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  -- 1
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  -- 2
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  -- 3
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  -- 4
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  -- 5
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 6
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 7
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  -- 8
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  -- 9
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 10
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  -- 11
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  -- 12
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  -- 13
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 14
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  -- 15
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  -- 16
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  -- 17
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  -- 18
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  -- 19
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  -- 20
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  -- 21
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  -- 22
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  -- 23
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  -- 24
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  -- 25
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  -- 26
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  -- 27
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  -- 28
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  -- 29
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  -- 30
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  -- 31
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  -- 32
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  -- 33
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  -- 34
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  -- 35
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  -- 36
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  -- 37
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  -- 38
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  -- 39
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  -- 40
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  -- 41
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  -- 42
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  -- 43
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  -- 44
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  -- 45
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  -- 46
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  -- 47
                    (10,  1,       '2017-03-08 01:00:00', NULL                 );  -- 48
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  -- 1
                 (1,      3,    800  ),  -- 2
                 (1,      4,    1000 ),  -- 3
                 (2,      3,    600  ),  -- 4
                 (2,      4,    800  ),  -- 5
                 (3,      4,    600  ),  -- 6
                 (5,      6,    600  ),  -- 7
                 (5,      7,    800  ),  -- 8
                 (5,      8,    1000 ),  -- 9
                 (6,      7,    600  ),  -- 10
                 (6,      8,    800  ),  -- 11
                 (7,      8,    600  ),  -- 12
                 (9,      10,   600  ),  -- 13
                 (9,      11,   800  ),  -- 14
                 (9,      12,   1000 ),  -- 15
                 (10,     11,   600  ),  -- 16
                 (10,     12,   800  ),  -- 17
                 (11,     12,   600  ),  -- 18
                 (13,     14,   600  ),  -- 19
                 (13,     15,   800  ),  -- 20
                 (13,     16,   1000 ),  -- 21
                 (14,     15,   600  ),  -- 22
                 (14,     16,   800  ),  -- 23
                 (15,     16,   600  ),  -- 24
                 (17,     18,   600  ),  -- 25
                 (17,     19,   800  ),  -- 26
                 (17,     20,   1000 ),  -- 27
                 (18,     19,   600  ),  -- 28
                 (18,     20,   800  ),  -- 29
                 (19,     20,   600  ),  -- 30
                 (21,     22,   600  ),  -- 31
                 (21,     23,   800  ),  -- 32
                 (21,     24,   1000 ),  -- 33
                 (22,     23,   600  ),  -- 34
                 (22,     24,   800  ),  -- 35
                 (23,     24,   600  ),  -- 36
                 (25,     26,   600  ),  -- 37
                 (25,     27,   800  ),  -- 38
                 (25,     28,   1000 ),  -- 39
                 (25,     29,   1200 ),  -- 40
                 (25,     30,   1400 ),  -- 41
                 (26,     27,   600  ),  -- 42
                 (26,     28,   800  ),  -- 43
                 (26,     29,   1000 ),  -- 44
                 (26,     30,   1200 ),  -- 45
                 (27,     28,   600  ),  -- 46
                 (27,     29,   800  ),  -- 47
                 (27,     30,   1000 ),  -- 48
                 (28,     29,   600  ),  -- 49
                 (28,     30,   800  ),  -- 50
                 (29,     30,   600  ),  -- 51
                 (31,     32,   600  ),  -- 52
                 (31,     33,   800  ),  -- 53
                 (31,     34,   1000 ),  -- 54
                 (31,     35,   1200 ),  -- 55
                 (31,     36,   1400 ),  -- 56
                 (32,     33,   600  ),  -- 57
                 (32,     34,   800  ),  -- 58
                 (32,     35,   1000 ),  -- 59
                 (32,     36,   1200 ),  -- 60
                 (33,     34,   600  ),  -- 61
                 (33,     35,   800  ),  -- 62
                 (33,     36,   1000 ),  -- 63
                 (34,     35,   600  ),  -- 64
                 (34,     36,   800  ),  -- 65
                 (35,     36,   600  ),  -- 66
                 (37,     38,   600  ),  -- 67
                 (37,     39,   800  ),  -- 68
                 (37,     40,   1000 ),  -- 69
                 (37,     41,   1200 ),  -- 70
                 (37,     42,   1400 ),  -- 71
                 (38,     39,   600  ),  -- 72
                 (38,     40,   800  ),  -- 73
                 (38,     41,   1000 ),  -- 74
                 (38,     42,   1200 ),  -- 75
                 (39,     40,   600  ),  -- 76
                 (39,     41,   800  ),  -- 77
                 (39,     42,   1000 ),  -- 78
                 (40,     41,   600  ),  -- 79
                 (40,     42,   800  ),  -- 80
                 (41,     42,   600  ),  -- 81
                 (43,     44,   600  ),  -- 82
                 (43,     45,   800  ),  -- 83
                 (43,     46,   1000 ),  -- 84
                 (43,     47,   1200 ),  -- 85
                 (43,     48,   1400 ),  -- 86
                 (44,     45,   600  ),  -- 87
                 (44,     46,   800  ),  -- 88
                 (44,     47,   1000 ),  -- 89
                 (44,     48,   1200 ),  -- 90
                 (45,     46,   600  ),  -- 91
                 (45,     47,   800  ),  -- 92
                 (45,     48,   1000 ),  -- 93
                 (46,     47,   600  ),  -- 94
                 (46,     48,   800  ),  -- 95
                 (47,     48,   600  );  -- 96
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  -- 1
                  (1,        9,    25   ),  -- 2
                  (1,        14,   22   ),  -- 3
                  (1,        23,   22   ),  -- 4
                  (2,        14,   25   ),  -- 5
                  (2,        23,   25   ),  -- 6
                  (2,        27,   20   ),  -- 7
                  (2,        33,   20   ),  -- 8
                  (3,        27,   25   ),  -- 9
                  (3,        33,   25   ),  -- 10
                  (3,        41,   25   ),  -- 11
                  (3,        56,   25   ),  -- 12
                  (4,        41,   17   ),  -- 13
                  (4,        56,   17   ),  -- 14
                  (4,        69,   23   ),  -- 15
                  (4,        93,   23   ),  -- 16
                  (5,        69,   25   ),  -- 17
                  (5,        93,   25   ),  -- 18
                  (5,        3,    21   ),  -- 19
                  (5,        9,    21   );  -- 20


-------
05/50/2017 18:50:20
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  -- 1
                                         ('Мосгортранс'),   -- 2
                                         ('АвтоТрансЮг');   -- 3
INSERT INTO Stations(StationName) VALUES('Москва'),            -- 1
                                        ('Тверь'),             -- 2
                                        ('Великий Новгород'),  -- 3
                                        ('Санкт-Петербург'),   -- 4
                                        ('Ярославль'),         -- 5
                                        ('Вологда'),           -- 6
                                        ('Череповец'),         -- 7
                                        ('Владимир'),          -- 8
                                        ('Нижний Новгород'),   -- 9
                                        ('Казань'),            -- 10
                                        ('Липецк'),            -- 11
                                        ('Воронеж'),           -- 12
                                        ('Ростов-на-Дону'),    -- 13
                                        ('Краснодар'),         -- 14
                                        ('Сочи'),              -- 15
                                        ('Рязань'),            -- 16
                                        ('Пенза'),             -- 17
                                        ('Ульяновск'),         -- 18
                                        ('Тольятти'),          -- 19
                                        ('Самара');            -- 20
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  -- 1
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  -- 2
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  -- 3
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  -- 4
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com');  -- 5
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  -- 1
                ('ЭК-946',  2,       56         ),  -- 2
                ('479МА',   3,       60         ),  -- 3
                ('ЮА79К',   3,       56         ),  -- 4
                ('9368',    2,       48         ),  -- 5
                ('ST36',    1,       56         ),  -- 6
                ('MA-397',  2,       52         ),  -- 7
                ('EW-98',   3,       58         ),  -- 8
                ('В-269',   2,       60         ),  -- 9
                ('СП-248',  1,       52         );  -- 10
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  -- 1
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  -- 2
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  -- 3
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  -- 4
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  -- 5
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 6
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 7
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  -- 8
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  -- 9
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  -- 10
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  -- 11
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  -- 12
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  -- 13
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  -- 14
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  -- 15
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  -- 16
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  -- 17
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  -- 18
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  -- 19
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  -- 20
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  -- 21
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  -- 22
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  -- 23
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  -- 24
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  -- 25
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  -- 26
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  -- 27
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  -- 28
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  -- 29
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  -- 30
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  -- 31
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  -- 32
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  -- 33
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  -- 34
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  -- 35
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  -- 36
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  -- 37
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  -- 38
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  -- 39
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  -- 40
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  -- 41
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  -- 42
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  -- 43
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  -- 44
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  -- 45
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  -- 46
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  -- 47
                    (10,  1,       '2017-03-08 01:00:00', NULL                 );  -- 48
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  -- 1
                 (1,      3,    800  ),  -- 2
                 (1,      4,    1000 ),  -- 3
                 (2,      3,    600  ),  -- 4
                 (2,      4,    800  ),  -- 5
                 (3,      4,    600  ),  -- 6
                 (5,      6,    600  ),  -- 7
                 (5,      7,    800  ),  -- 8
                 (5,      8,    1000 ),  -- 9
                 (6,      7,    600  ),  -- 10
                 (6,      8,    800  ),  -- 11
                 (7,      8,    600  ),  -- 12
                 (9,      10,   600  ),  -- 13
                 (9,      11,   800  ),  -- 14
                 (9,      12,   1000 ),  -- 15
                 (10,     11,   600  ),  -- 16
                 (10,     12,   800  ),  -- 17
                 (11,     12,   600  ),  -- 18
                 (13,     14,   600  ),  -- 19
                 (13,     15,   800  ),  -- 20
                 (13,     16,   1000 ),  -- 21
                 (14,     15,   600  ),  -- 22
                 (14,     16,   800  ),  -- 23
                 (15,     16,   600  ),  -- 24
                 (17,     18,   600  ),  -- 25
                 (17,     19,   800  ),  -- 26
                 (17,     20,   1000 ),  -- 27
                 (18,     19,   600  ),  -- 28
                 (18,     20,   800  ),  -- 29
                 (19,     20,   600  ),  -- 30
                 (21,     22,   600  ),  -- 31
                 (21,     23,   800  ),  -- 32
                 (21,     24,   1000 ),  -- 33
                 (22,     23,   600  ),  -- 34
                 (22,     24,   800  ),  -- 35
                 (23,     24,   600  ),  -- 36
                 (25,     26,   600  ),  -- 37
                 (25,     27,   800  ),  -- 38
                 (25,     28,   1000 ),  -- 39
                 (25,     29,   1200 ),  -- 40
                 (25,     30,   1400 ),  -- 41
                 (26,     27,   600  ),  -- 42
                 (26,     28,   800  ),  -- 43
                 (26,     29,   1000 ),  -- 44
                 (26,     30,   1200 ),  -- 45
                 (27,     28,   600  ),  -- 46
                 (27,     29,   800  ),  -- 47
                 (27,     30,   1000 ),  -- 48
                 (28,     29,   600  ),  -- 49
                 (28,     30,   800  ),  -- 50
                 (29,     30,   600  ),  -- 51
                 (31,     32,   600  ),  -- 52
                 (31,     33,   800  ),  -- 53
                 (31,     34,   1000 ),  -- 54
                 (31,     35,   1200 ),  -- 55
                 (31,     36,   1400 ),  -- 56
                 (32,     33,   600  ),  -- 57
                 (32,     34,   800  ),  -- 58
                 (32,     35,   1000 ),  -- 59
                 (32,     36,   1200 ),  -- 60
                 (33,     34,   600  ),  -- 61
                 (33,     35,   800  ),  -- 62
                 (33,     36,   1000 ),  -- 63
                 (34,     35,   600  ),  -- 64
                 (34,     36,   800  ),  -- 65
                 (35,     36,   600  ),  -- 66
                 (37,     38,   600  ),  -- 67
                 (37,     39,   800  ),  -- 68
                 (37,     40,   1000 ),  -- 69
                 (37,     41,   1200 ),  -- 70
                 (37,     42,   1400 ),  -- 71
                 (38,     39,   600  ),  -- 72
                 (38,     40,   800  ),  -- 73
                 (38,     41,   1000 ),  -- 74
                 (38,     42,   1200 ),  -- 75
                 (39,     40,   600  ),  -- 76
                 (39,     41,   800  ),  -- 77
                 (39,     42,   1000 ),  -- 78
                 (40,     41,   600  ),  -- 79
                 (40,     42,   800  ),  -- 80
                 (41,     42,   600  ),  -- 81
                 (43,     44,   600  ),  -- 82
                 (43,     45,   800  ),  -- 83
                 (43,     46,   1000 ),  -- 84
                 (43,     47,   1200 ),  -- 85
                 (43,     48,   1400 ),  -- 86
                 (44,     45,   600  ),  -- 87
                 (44,     46,   800  ),  -- 88
                 (44,     47,   1000 ),  -- 89
                 (44,     48,   1200 ),  -- 90
                 (45,     46,   600  ),  -- 91
                 (45,     47,   800  ),  -- 92
                 (45,     48,   1000 ),  -- 93
                 (46,     47,   600  ),  -- 94
                 (46,     48,   800  ),  -- 95
                 (47,     48,   600  );  -- 96
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  -- 1
                  (1,        9,    25   ),  -- 2
                  (1,        14,   22   ),  -- 3
                  (1,        23,   22   ),  -- 4
                  (2,        14,   25   ),  -- 5
                  (2,        23,   25   ),  -- 6
                  (2,        27,   20   ),  -- 7
                  (2,        33,   20   ),  -- 8
                  (3,        27,   25   ),  -- 9
                  (3,        33,   25   ),  -- 10
                  (3,        41,   25   ),  -- 11
                  (3,        56,   25   ),  -- 12
                  (4,        41,   17   ),  -- 13
                  (4,        56,   17   ),  -- 14
                  (4,        69,   23   ),  -- 15
                  (4,        93,   23   ),  -- 16
                  (5,        69,   25   ),  -- 17
                  (5,        93,   25   ),  -- 18
                  (5,        3,    21   ),  -- 19
                  (5,        9,    21   );  -- 20


-------
05/51/2017 18:51:00
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/54/2017 18:54:27
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/03/2017 19:03:04
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/05/2017 19:05:04
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/05/2017 19:05:06
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/05/2017 19:05:06
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/13/2017 19:13:38
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/13/2017 19:13:40
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/13/2017 19:13:41
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/38/2017 19:38:46
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/38/2017 19:38:48
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/38/2017 19:38:49
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/41/2017 19:41:39
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/49/2017 19:49:03
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/49/2017 19:49:33
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/52/2017 19:52:19
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/52/2017 19:52:21
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/52/2017 19:52:21
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/52/2017 19:52:40
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/53/2017 19:53:06
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/56/2017 19:56:03
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/56/2017 19:56:05
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/56/2017 19:56:05
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/59/2017 19:59:35
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/00/2017 20:00:19
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/04/2017 20:04:03
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/04/2017 20:04:05
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/04/2017 20:04:05
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/28/2017 20:28:49
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/29/2017 20:29:06
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/29/2017 20:29:08
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/29/2017 20:29:08
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/29/2017 20:29:26
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/29/2017 20:29:28
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/29/2017 20:29:28
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/30/2017 20:30:05
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/30/2017 20:30:07
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/30/2017 20:30:07
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/49/2017 20:49:38
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/50/2017 20:50:49
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/57/2017 20:57:05
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/03/2017 21:03:04
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/14/2017 21:14:36
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/15/2017 21:15:18
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/16/2017 21:16:56
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/29/2017 21:29:05
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/38/2017 21:38:48
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/39/2017 21:39:37
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/45/2017 21:45:56
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/46/2017 21:46:10
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/47/2017 21:47:03
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/47/2017 21:47:45
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/50/2017 21:50:11
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/50/2017 21:50:27
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/50/2017 21:50:29
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/50/2017 21:50:34
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/50/2017 21:50:36
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/58/2017 21:58:37
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/00/2017 22:00:27
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20


-------
05/00/2017 22:00:35
-------

DROP DATABASE IF EXISTS Bus_station 
CREATE DATABASE Bus_station
CHARACTER SET 'utf8' 
USE Bus_station 
CREATE TABLE Companies(
	Company INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CompanyName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Clients(
	Client INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	FirstName NVARCHAR(510) NOT NULL,
    LastName NVARCHAR(510) NOT NULL,
	Patronymic NVARCHAR(510) NULL,
	Address NVARCHAR(510) NOT NULL,
    Telephone VARCHAR(30) NOT NULL UNIQUE,
    Email VARCHAR(100) NOT NULL UNIQUE
) 
CREATE TABLE Stations(
	Station INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	StationName NVARCHAR(510) NOT NULL UNIQUE
) 
CREATE TABLE Runs(
	Run INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	RunNumber NVARCHAR(10) NOT NULL UNIQUE,
	Company INTEGER NOT NULL REFERENCES Companies(Company) ON DELETE CASCADE ON UPDATE CASCADE,
	BusCapacity INTEGER NOT NULL
) 
CREATE TABLE Stops(
	Stop_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Run INTEGER NOT NULL REFERENCES Runs(Run) ON DELETE CASCADE ON UPDATE CASCADE,
	Station INTEGER NOT NULL REFERENCES Stations(Station) ON DELETE CASCADE ON UPDATE CASCADE,
	Arrival DATETIME NULL,
	Departure DATETIME NULL,
    UNIQUE (Run, Station),
    CHECK (Departure IS NULL OR Arrival IS NULL OR Departure > Arrival)
) 
CREATE TRIGGER IntersectElimination
BEFORE INSERT ON Stops
FOR EACH ROW
BEGIN
	IF EXISTS (
		SELECT *
		FROM Stops s
		WHERE NEW.Run = s.Run
			  AND (
          s.Arrival IS NULL AND NEW.Arrival <= s.Departure OR
          s.Departure IS NULL AND NEW.Departure >= s.Arrival OR
          NEW.Arrival IS NULL AND s.Arrival <= NEW.Departure OR
          NEW.Departure IS NULL AND s.Departure >= NEW.Arrival OR
          s.Arrival IS NOT NULL AND s.Departure IS NOT NULL AND NEW.Arrival IS NOT NULL AND NEW.Departure IS NOT NULL AND
          (
				      NEW.Arrival between s.Arrival AND s.Departure OR
				      s.Arrival between NEW.Arrival AND NEW.Departure
          )
			  )
	) THEN
		SIGNAL SQLSTATE '11111';
	END IF;
END 
CREATE TRIGGER SingleSourceAndDest
AFTER INSERT ON Stops
FOR EACH ROW
BEGIN
	IF (
		NEW.Arrival IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Arrival IS NULL AND Run = NEW.Run
        ) != 1 OR
		NEW.Departure IS NULL AND (
			SELECT COUNT(*)
            FROM Stops
            WHERE Departure IS NULL AND Run = NEW.Run
        ) != 1
    ) THEN
		SIGNAL SQLSTATE '22222';
	END IF;
END 
CREATE TABLE Parts(
	Part INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    From_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    To_ INTEGER NOT NULL REFERENCES Stops(Stop_) ON DELETE CASCADE ON UPDATE CASCADE,
    Price DECIMAL(8,2) NOT NULL,
    UNIQUE (From_, To_)
) 
CREATE TRIGGER SameRuns_AND_ToGraterThanFrom
AFTER INSERT ON Parts
FOR EACH ROW
BEGIN
	IF NOT EXISTS (
			SELECT *
			FROM Stops f JOIN
				 Stops t ON f.Run = t.Run AND
							   f.Stop_ = NEW.From_ AND
                               t.Stop_ = NEW.To_ AND
							   (f.Arrival IS NULL OR t.Departure IS NULL OR f.Arrival < t.Arrival)
	) THEN
		SIGNAL SQLSTATE '33333';
	END IF;
END 
CREATE TABLE Orders(
	Order_ INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	Client INTEGER NOT NULL REFERENCES Clients(Client) ON DELETE CASCADE ON UPDATE CASCADE,
	Part INTEGER NOT NULL REFERENCES Parts(Part) ON DELETE RESTRICT ON UPDATE RESTRICT,
    Count INTEGER NOT NULL DEFAULT 1,
    Price DECIMAL(8,2) NOT NULL
) 
CREATE TRIGGER DefaultPrice
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	IF (NEW.Price IS NULL)
    THEN
		SET NEW.Price = (
			SELECT Price
            FROM Parts
            WHERE Part = NEW.Part
        );
	END IF;
END 
CREATE VIEW Parts_with_free_space
AS SELECT Parts.Part, BusCapacity-SUM(IFNULL(Count, 0)) as Free
FROM Runs JOIN
     Stops as f ON Runs.Run = f.Run JOIN
     Stops as t ON Runs.Run = t.Run JOIN
     Parts ON From_ = f.Stop_ AND To_ = t.Stop_ JOIN
	 Stops as fc ON fc.Run = Runs.Run JOIN
	 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
     Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
     Orders ON Orders.Part = pc.Part
GROUP BY Part 
CREATE TRIGGER BusOverflow
BEFORE INSERT ON Orders
FOR EACH ROW
BEGIN
	DECLARE x integer;
	SELECT BusCapacity-SUM(IFNULL(Orders.Count, 0))-new.Count INTO x
	FROM Runs JOIN
		 Stops as f ON Runs.Run = f.Run JOIN
		 Stops as t ON Runs.Run = t.Run JOIN
		 Parts ON From_ = f.Stop_ AND To_ = t.Stop_ AND Parts.Part = new.Part JOIN
		 Stations as fs ON f.Station = fs.Station JOIN
		 Stations as ts ON t.Station = ts.Station JOIN
		 Stops as fc ON fc.Run = Runs.Run JOIN
		 Stops as tc ON fc.Run = Runs.Run AND NOT (tc.Arrival <= f.Departure OR fc.Departure >= t.Arrival) JOIN
		 Parts as pc ON pc.From_ = fc.Stop_ AND pc.To_ = tc.Stop_ LEFT JOIN
		 Orders ON Orders.Part = pc.Part;
	IF ( x < 0 ) THEN
		SIGNAL SQLSTATE '44444';
	END IF;
END 

USE Bus_station 
INSERT INTO Companies(CompanyName) VALUES('Мострансавто'),  
                                         ('Мосгортранс'),   
                                         ('АвтоТрансЮг') 
INSERT INTO Stations(StationName) VALUES('Москва'),            
                                        ('Тверь'),             
                                        ('Великий Новгород'),  
                                        ('Санкт-Петербург'),   
                                        ('Ярославль'),         
                                        ('Вологда'),           
                                        ('Череповец'),         
                                        ('Владимир'),          
                                        ('Нижний Новгород'),   
                                        ('Казань'),            
                                        ('Липецк'),            
                                        ('Воронеж'),           
                                        ('Ростов-на-Дону'),    
                                        ('Краснодар'),         
                                        ('Сочи'),              
                                        ('Рязань'),            
                                        ('Пенза'),             
                                        ('Ульяновск'),         
                                        ('Тольятти'),          
                                        ('Самара') 
INSERT INTO Clients(LastName,     FirstName,   Patronymic,   Address,                      Telephone,       Email)
             VALUES('Меркушева',  'Татьяна',   'Сергеевна',  'Карла Маркса, 37',           '+79992847501',  'tatyana-merk@mail.ru'     ),  
                   ('Нечаева',    'Татьяна',   'Юрьевна',    '50 лет Октября, 27-104',     '+79254074876',  'nech.tat685@gmail.com'    ),  
                   ('Антипов',    'Николай',   'Андреевич',  'Хорошева, 39-24',            '+79022345694',  'kolya2863@yandex.ru'      ),  
                   ('Плотников',  'Максим',    'Вадимович',  'Ломоносовский пр-т, 27к11',  '+79505463892',  'maxyta88@gmail.com'       ),  
                   ('Сторожева',  'Зоя',       'Андреевна',  'Володарского, 27а',          '+79080481269',  'storozheva.z11@icloud.com') 
INSERT INTO Runs(RunNumber, Company, BusCapacity)
          VALUES('AB-379',  1,       48         ),  
                ('ЭК-946',  2,       56         ),  
                ('479МА',   3,       60         ),  
                ('ЮА79К',   3,       56         ),  
                ('9368',    2,       48         ),  
                ('ST36',    1,       56         ),  
                ('MA-397',  2,       52         ),  
                ('EW-98',   3,       58         ),  
                ('В-269',   2,       60         ),  
                ('СП-248',  1,       52         ) 
INSERT INTO Stops(Run, Station, Arrival,               Departure            )
              VALUES(1,   1,       NULL,                  '2017-02-28 09:00:00'),  
                    (1,   2,       '2017-02-28 12:00:00', '2017-02-28 12:15:00'),  
                    (1,   3,       '2017-02-28 18:00:00', '2017-02-28 18:15:00'),  
                    (1,   4,       '2017-02-28 21:00:00', NULL                 ),  
                    (2,   4,       NULL,                  '2017-03-01 09:00:00'),  
                    (2,   3,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (2,   2,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (2,   1,       '2017-03-01 21:00:00', NULL                 ),  
                    (3,   1,       NULL,                  '2017-03-01 09:00:00'),  
                    (3,   5,       '2017-03-01 12:00:00', '2017-03-01 12:15:00'),  
                    (3,   6,       '2017-03-01 14:00:00', '2017-03-01 14:15:00'),  
                    (3,   7,       '2017-03-01 16:00:00', NULL                 ),  
                    (4,   7,       NULL,                  '2017-03-01 16:15:00'),  
                    (4,   6,       '2017-03-01 18:00:00', '2017-03-01 18:15:00'),  
                    (4,   5,       '2017-03-01 20:00:00', '2017-03-01 20:15:00'),  
                    (4,   1,       '2017-03-01 23:00:00', NULL                 ),  
                    (5,   1,       NULL,                  '2017-03-02 09:00:00'),  
                    (5,   8,       '2017-03-02 12:00:00', '2017-03-02 12:15:00'),  
                    (5,   9,       '2017-03-02 16:00:00', '2017-03-02 16:15:00'),  
                    (5,   10,      '2017-03-03 02:00:00', NULL                 ),  
                    (6,   10,      NULL,                  '2017-03-03 09:00:00'),  
                    (6,   9,       '2017-03-03 19:00:00', '2017-03-03 19:15:00'),  
                    (6,   8,       '2017-03-03 23:00:00', '2017-03-03 23:15:00'),  
                    (6,   1,       '2017-03-04 02:00:00', NULL                 ),  
                    (7,   1,       NULL,                  '2017-03-04 09:00:00'),  
                    (7,   11,      '2017-03-04 13:00:00', '2017-03-04 13:15:00'),  
                    (7,   12,      '2017-03-04 15:00:00', '2017-03-04 15:15:00'),  
                    (7,   13,      '2017-03-04 23:00:00', '2017-03-04 23:15:00'),  
                    (7,   14,      '2017-03-05 02:00:00', '2017-03-05 02:15:00'),  
                    (7,   15,      '2017-03-05 04:00:00', NULL                 ),  
                    (8,   15,      NULL,                  '2017-03-05 09:00:00'),  
                    (8,   14,      '2017-03-05 11:00:00', '2017-03-05 11:15:00'),  
                    (8,   13,      '2017-03-05 14:00:00', '2017-03-05 14:15:00'),  
                    (8,   12,      '2017-03-05 22:00:00', '2017-03-05 22:15:00'),  
                    (8,   11,      '2017-03-06 00:00:00', '2017-03-06 00:15:00'),  
                    (8,   1,       '2017-03-06 04:00:00', NULL                 ),  
                    (9,   1,       NULL,                  '2017-03-06 09:00:00'),  
                    (9,   16,      '2017-03-06 13:00:00', '2017-03-06 13:15:00'),  
                    (9,   17,      '2017-03-06 17:00:00', '2017-03-06 17:15:00'),  
                    (9,   18,      '2017-03-06 21:00:00', '2017-03-06 21:15:00'),  
                    (9,   19,      '2017-03-06 23:00:00', '2017-03-06 23:15:00'),  
                    (9,   20,      '2017-03-07 01:00:00', NULL                 ),  
                    (10,  20,      NULL,                  '2017-03-07 09:00:00'),  
                    (10,  19,      '2017-03-07 11:00:00', '2017-03-07 11:15:00'),  
                    (10,  18,      '2017-03-07 13:00:00', '2017-03-07 13:15:00'),  
                    (10,  17,      '2017-03-07 17:00:00', '2017-03-07 17:15:00'),  
                    (10,  16,      '2017-03-07 21:00:00', '2017-03-07 21:15:00'),  
                    (10,  1,       '2017-03-08 01:00:00', NULL                 ) 
INSERT INTO Parts(From_, To_, Price)
           VALUES(1,      2,    600  ),  
                 (1,      3,    800  ),  
                 (1,      4,    1000 ),  
                 (2,      3,    600  ),  
                 (2,      4,    800  ),  
                 (3,      4,    600  ),  
                 (5,      6,    600  ),  
                 (5,      7,    800  ),  
                 (5,      8,    1000 ),  
                 (6,      7,    600  ),  
                 (6,      8,    800  ),  
                 (7,      8,    600  ),  
                 (9,      10,   600  ),  
                 (9,      11,   800  ),  
                 (9,      12,   1000 ),  
                 (10,     11,   600  ),  
                 (10,     12,   800  ),  
                 (11,     12,   600  ),  
                 (13,     14,   600  ),  
                 (13,     15,   800  ),  
                 (13,     16,   1000 ),  
                 (14,     15,   600  ),  
                 (14,     16,   800  ),  
                 (15,     16,   600  ),  
                 (17,     18,   600  ),  
                 (17,     19,   800  ),  
                 (17,     20,   1000 ),  
                 (18,     19,   600  ),  
                 (18,     20,   800  ),  
                 (19,     20,   600  ),  
                 (21,     22,   600  ),  
                 (21,     23,   800  ),  
                 (21,     24,   1000 ),  
                 (22,     23,   600  ),  
                 (22,     24,   800  ),  
                 (23,     24,   600  ),  
                 (25,     26,   600  ),  
                 (25,     27,   800  ),  
                 (25,     28,   1000 ),  
                 (25,     29,   1200 ),  
                 (25,     30,   1400 ),  
                 (26,     27,   600  ),  
                 (26,     28,   800  ),  
                 (26,     29,   1000 ),  
                 (26,     30,   1200 ),  
                 (27,     28,   600  ),  
                 (27,     29,   800  ),  
                 (27,     30,   1000 ),  
                 (28,     29,   600  ),  
                 (28,     30,   800  ),  
                 (29,     30,   600  ),  
                 (31,     32,   600  ),  
                 (31,     33,   800  ),  
                 (31,     34,   1000 ),  
                 (31,     35,   1200 ),  
                 (31,     36,   1400 ),  
                 (32,     33,   600  ),  
                 (32,     34,   800  ),  
                 (32,     35,   1000 ),  
                 (32,     36,   1200 ),  
                 (33,     34,   600  ),  
                 (33,     35,   800  ),  
                 (33,     36,   1000 ),  
                 (34,     35,   600  ),  
                 (34,     36,   800  ),  
                 (35,     36,   600  ),  
                 (37,     38,   600  ),  
                 (37,     39,   800  ),  
                 (37,     40,   1000 ),  
                 (37,     41,   1200 ),  
                 (37,     42,   1400 ),  
                 (38,     39,   600  ),  
                 (38,     40,   800  ),  
                 (38,     41,   1000 ),  
                 (38,     42,   1200 ),  
                 (39,     40,   600  ),  
                 (39,     41,   800  ),  
                 (39,     42,   1000 ),  
                 (40,     41,   600  ),  
                 (40,     42,   800  ),  
                 (41,     42,   600  ),  
                 (43,     44,   600  ),  
                 (43,     45,   800  ),  
                 (43,     46,   1000 ),  
                 (43,     47,   1200 ),  
                 (43,     48,   1400 ),  
                 (44,     45,   600  ),  
                 (44,     46,   800  ),  
                 (44,     47,   1000 ),  
                 (44,     48,   1200 ),  
                 (45,     46,   600  ),  
                 (45,     47,   800  ),  
                 (45,     48,   1000 ),  
                 (46,     47,   600  ),  
                 (46,     48,   800  ),  
                 (47,     48,   600  ) 
INSERT INTO Orders(Client, Part, Count)
            VALUES(1,        3,    25   ),  
                  (1,        9,    25   ),  
                  (1,        14,   22   ),  
                  (1,        23,   22   ),  
                  (2,        14,   25   ),  
                  (2,        23,   25   ),  
                  (2,        27,   20   ),  
                  (2,        33,   20   ),  
                  (3,        27,   25   ),  
                  (3,        33,   25   ),  
                  (3,        41,   25   ),  
                  (3,        56,   25   ),  
                  (4,        41,   17   ),  
                  (4,        56,   17   ),  
                  (4,        69,   23   ),  
                  (4,        93,   23   ),  
                  (5,        69,   25   ),  
                  (5,        93,   25   ),  
                  (5,        3,    21   ),  
                  (5,        9,    21   );  -- 20

